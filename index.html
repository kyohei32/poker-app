<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>Poker Settlement (Hold'em)</title>

<!-- PWA / Android -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#5b2a86">

<!-- iPhone対応（①②） -->
<link rel="apple-touch-icon" href="./icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Poker">

<style>
:root{--bd:#ddd;--m:#666;--pill:#fafafa;--plus:#2563eb;--minus:#dc2626}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:16px}
h1{font-size:18px;margin:0 0 8px}
.muted{color:var(--m);font-size:12px;line-height:1.4}
.card{border:1px solid var(--bd);border-radius:12px;padding:12px;margin:12px 0;background:#fff}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
.spacer{flex:1}
label{font-size:12px;margin:0 0 4px;display:block;color:#333}
input{padding:10px;border:1px solid #ccc;border-radius:10px;width:140px;font-size:16px}
button{padding:10px 12px;border:1px solid #ccc;border-radius:999px;background:#fff;cursor:pointer;font-size:14px}
button.primary{font-weight:600;border-color:#999}
button.danger{border-color:#f2b2b2}
button.mini{font-size:13px;padding:8px 10px}
.btnbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{display:inline-block;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;font-size:12px;background:var(--pill);margin:6px 6px 0 0}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--bd);display:inline-block}
.ok{color:#0a7a2f}.warn{color:#b45309}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:10px 8px}
th{font-size:12px;color:#444;white-space:nowrap}
td{font-size:14px;vertical-align:middle}
.num{text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap}
.profitPlus{color:var(--plus);font-weight:700}
.profitMinus{color:var(--minus);font-weight:700}
.profitZero{color:#444}
textarea{width:100%;min-height:180px;border-radius:10px;padding:10px;border:1px solid #ccc;font-size:14px}
.desktopOnly{display:block}.mobileOnly{display:none}
.pCard{border:1px solid #eee;border-radius:12px;padding:10px;margin-top:10px}
.pGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
.pGrid .full{grid-column:1/-1}
.pField input{width:100%}
.pMeta{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:10px;flex-wrap:wrap}
.pMeta .kv{font-size:12px;color:#444}
.pMeta .kv b{font-size:14px}
.pActions{display:flex;gap:8px;margin-top:10px}
@media(max-width:720px){
  body{margin:12px}
  input{width:100%}
  .spacer{display:none}
  .desktopOnly{display:none}
  .mobileOnly{display:block}
}
</style>
</head>

<body>

<h1>ポーカー収支・精算</h1>
<div class="muted">SB-BB点数と1BB円を設定 → Buy-in／Final入力 → 整合確認 → 集計</div>

<div class="card">
  <div class="btnbar">
    <span class="muted">レート点数：</span>
    <button class="mini" data-rate="1,2">1-2</button>
    <button class="mini" data-rate="25,50">25-50</button>
    <button class="mini" data-rate="50,100">50-100</button>
  </div>
  <div class="btnbar" style="margin-top:8px;">
    <span class="muted">1BB円：</span>
    <button class="mini" data-bbyen="50">50</button>
    <button class="mini" data-bbyen="100">100</button>
    <button class="mini" data-bbyen="200">200</button>
  </div>

  <div class="row" style="margin-top:12px;">
    <div style="flex:1;min-width:220px">
      <label>SB（点）</label>
      <input id="sbPts" type="number" inputmode="numeric" pattern="[0-9]*">
    </div>
    <div style="flex:1;min-width:220px">
      <label>BB（点）</label>
      <input id="bbPts" type="number" inputmode="numeric" pattern="[0-9]*">
    </div>
    <div style="flex:1;min-width:220px">
      <label>1BBあたり（円）</label>
      <input id="bbYen" type="number" inputmode="numeric" pattern="[0-9]*">
    </div>

    <div class="spacer"></div>
    <button id="addPlayer" class="primary">＋参加者</button>
    <button id="resetAll" class="danger">初期化</button>
  </div>

  <div>
    <span class="pill">1点あたり：<b><span id="yenPerPt">0</span> 円</b></span>
    <span class="pill">設定レート：<b><span id="rateText">-</span></b></span>
  </div>
</div>

<div class="card">
  <div class="row" style="align-items:center">
    <div>
      <div class="muted">整合チェック</div>
      <div id="integrity" class="badge">未計算</div>
    </div>
    <div>
      <div class="muted">保存状態</div>
      <div id="saveState" class="badge">-</div>
    </div>
    <div class="spacer"></div>
    <div class="muted">合計Buy-in: <b><span id="sumBuyIn">0</span>円</b></div>
    <div class="muted">期待総点数: <b><span id="expectedPts">0</span></b></div>
    <div class="muted">Final合計: <b><span id="sumFinalPts">0</span></b></div>
  </div>

  <div class="desktopOnly" style="margin-top:10px;">
    <table>
      <thead>
        <tr>
          <th>名前</th>
          <th class="num">Buy-in（円）</th>
          <th class="num">Final（点）</th>
          <th class="num">全体との差（点）</th>
          <th class="num">収支（円）</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="playersTbody"></tbody>
    </table>
  </div>

  <div class="mobileOnly" id="playersMobile"></div>

  <div class="row" style="margin-top:12px;align-items:center">
    <div class="muted">※スマホはカード表示（横スクロールなし）</div>
    <div class="spacer"></div>
    <button id="aggregate" class="primary">集計</button>
  </div>
</div>

<div class="card">
  <div class="row" style="align-items:center">
    <div><b>精算結果</b></div>
    <div class="spacer"></div>
    <button id="copySettlement" class="primary">コピー（全体）</button>
  </div>
  <div id="settlementList" class="muted" style="margin-top:10px;">未集計</div>
</div>

<div class="card">
  <div><b>コピー用テキスト（全体結果）</b></div>
  <textarea id="copyText" readonly></textarea>
</div>

<!-- 履歴（追加） -->
<div class="card">
  <div class="row" style="align-items:center">
    <div><b>履歴</b></div>
    <div class="spacer"></div>
    <button id="saveHistory" class="primary">この内容を履歴に保存</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <div style="flex:1;min-width:220px">
      <label>タイトル（任意）</label>
      <input id="historyTitle" type="text" placeholder="例）2/3 新宿 / 〇〇宅" style="width:100%">
    </div>
  </div>

  <div id="historyList" class="muted" style="margin-top:10px;">履歴なし</div>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const tbody = $("playersTbody"), mobileWrap = $("playersMobile");
  const sb=$("sbPts"), bb=$("bbPts"), bbYen=$("bbYen");
  const yenPerPtEl=$("yenPerPt"), rateText=$("rateText"), integrity=$("integrity"), saveState=$("saveState");
  const sumBuyInEl=$("sumBuyIn"), expectedPtsEl=$("expectedPts"), sumFinalPtsEl=$("sumFinalPts");
  const settlementList=$("settlementList"), copyText=$("copyText");

  const STORAGE_KEY="poker_settlement_v1";
  const HISTORY_KEY="poker_settlement_history_v1";
  let players=[], lastSettlementLines=[];
  let history=[];

  const fmtInt = (n)=>Math.round(Number(n||0)).toLocaleString("ja-JP");
  const num = (n)=>Number(n||0);
  const cls = (v)=>v>0?"profitPlus":v<0?"profitMinus":"profitZero";

  const yenPerPt = ()=> (!bb.value || !bbYen.value) ? 0 : num(bbYen.value)/num(bb.value);

  function totals(){
    const ypp=yenPerPt();
    let totalBuy=0,totalPts=0;
    for(const p of players){ totalBuy+=num(p.buyIn); totalPts+=num(p.finalPts); }
    const expectedTotalPts = ypp ? totalBuy/ypp : 0;
    return {ypp,totalBuy,totalPts,expectedTotalPts};
  }

  const profitYen = (p,ypp)=> ypp ? Math.round(num(p.finalPts)*ypp - num(p.buyIn)) : null;
  const diffPts = (p,ypp)=> ypp ? Math.round(num(p.finalPts) - (num(p.buyIn)/ypp)) : null;

  function snapshot(){
    return {
      sbPts: sb.value||"", bbPts: bb.value||"", bbYen: bbYen.value||"",
      players: players.map(p=>({id:p.id,name:p.name||"",buyIn:p.buyIn||"",finalPts:p.finalPts||""})),
      lastSettlementLines: lastSettlementLines||[]
    };
  }

  function save(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot()));
      saveState.textContent="保存済み";
      saveState.className="badge ok";
    }catch(e){
      saveState.textContent="保存失敗";
      saveState.className="badge warn";
    }
  }

  function buildFullCopyText(){
    const {ypp,totalBuy,totalPts,expectedTotalPts}=totals();
    const ok = ypp && Math.abs(totalPts-expectedTotalPts)<1e-6;

    const head=[
      "【ポーカー精算（全体結果）】",
      `レート点数：${sb.value&&bb.value?`${sb.value}-${bb.value}`:"-"}`,
      `1BBあたり：${bbYen.value?fmtInt(bbYen.value):"0"}円`,
      `1点あたり：${ypp?fmtInt(ypp):"0"}円`,
      "",
      `合計Buy-in：${fmtInt(totalBuy)}円`,
      `期待総点数：${fmtInt(expectedTotalPts)}`,
      `Final合計：${fmtInt(totalPts)}`,
      `整合チェック：${ok?"OK":"注意"}`,
      "",
      "【各メンバー】"
    ];

    const rows=players.map(p=>{
      const name=(p.name&&p.name.trim())?p.name.trim():"(未入力)";
      if(!ypp) return `- ${name} / Buy-in: ${fmtInt(p.buyIn)}円 / Final: ${fmtInt(p.finalPts)}点`;
      const d=diffPts(p,ypp), pr=profitYen(p,ypp);
      return `- ${name} / Buy-in: ${fmtInt(p.buyIn)}円 / Final: ${fmtInt(p.finalPts)}点 / 差: ${(d>0?"+":"")}${fmtInt(d)}点 / 収支: ${(pr>0?"+":"")}${fmtInt(pr)}円`;
    });

    const settle=["","【精算】",...((lastSettlementLines&&lastSettlementLines.length)?lastSettlementLines:["精算なし"])];
    return [...head,...rows,...settle].join("\n");
  }

  function updateComputed(p){
    const {ypp}=totals();
    const set = (el,txt,clsName)=>{ if(!el) return; el.textContent=txt; if(clsName!=null) el.className=clsName; };

    if(!ypp){
      set(p.dom.diffTd,"-");
      set(p.dom.profitTd,"-","num");
      set(p.dom.mDiff,"-");
      set(p.dom.mProf,"-","");
      return;
    }

    const d=diffPts(p,ypp), pr=profitYen(p,ypp);
    set(p.dom.diffTd,(d>0?"+":"")+fmtInt(d));
    set(p.dom.profitTd,(pr>0?"+":"")+fmtInt(pr)+"円","num "+cls(pr));
    set(p.dom.mDiff,(d>0?"+":"")+fmtInt(d));
    set(p.dom.mProf,(pr>0?"+":"")+fmtInt(pr)+"円",cls(pr));
  }

  function renderHeaderAndComputedAll(){
    const {ypp,totalBuy,totalPts,expectedTotalPts}=totals();

    yenPerPtEl.textContent = ypp ? fmtInt(ypp) : "0";
    rateText.textContent = (sb.value&&bb.value) ? `${sb.value}-${bb.value}` : "-";

    sumBuyInEl.textContent = fmtInt(totalBuy);
    sumFinalPtsEl.textContent = fmtInt(totalPts);
    expectedPtsEl.textContent = fmtInt(expectedTotalPts);

    const ok = ypp && Math.abs(totalPts-expectedTotalPts)<1e-6;
    integrity.textContent = ok ? "OK" : "注意";
    integrity.className = "badge " + (ok ? "ok" : "warn");

    for(const p of players) updateComputed(p);
    copyText.value = buildFullCopyText();
  }

  function bindPair(pcInput, mobileInput, getterSetter){
    const sync = (from,to)=>{ to.value = from.value; getterSetter(from.value); save(); renderHeaderAndComputedAll(); };
    pcInput.addEventListener("input", ()=>sync(pcInput, mobileInput));
    mobileInput.addEventListener("input", ()=>sync(mobileInput, pcInput));
  }

  function addPlayerWithData(d){
    const p={id:d.id,name:d.name||"",buyIn:d.buyIn||"",finalPts:d.finalPts||"",dom:{}};
    players.push(p);

    // PC row
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input style="width:100%;min-width:140px"></td>
      <td class="num"><input type="number" inputmode="numeric" pattern="[0-9]*" style="width:160px"></td>
      <td class="num"><input type="number" inputmode="numeric" pattern="[0-9]*" style="width:160px"></td>
      <td class="num">-</td>
      <td class="num">-</td>
      <td><button class="danger mini">削除</button></td>`;
    const [nameI,buyI,ptsI]=tr.querySelectorAll("input");
    const diffTd=tr.querySelectorAll("td")[3];
    const profitTd=tr.querySelectorAll("td")[4];

    nameI.value=p.name; buyI.value=p.buyIn; ptsI.value=p.finalPts;

    // Mobile card
    const card=document.createElement("div");
    card.className="pCard";
    card.innerHTML=`
      <div class="pGrid">
        <div class="pField full"><label>名前</label><input></div>
        <div class="pField"><label>Buy-in（円）</label><input type="number" inputmode="numeric" pattern="[0-9]*"></div>
        <div class="pField"><label>Final（点）</label><input type="number" inputmode="numeric" pattern="[0-9]*"></div>
      </div>
      <div class="pMeta">
        <div class="kv">全体との差（点）<br><b>-</b></div>
        <div class="kv">収支（円）<br><b>-</b></div>
      </div>
      <div class="pActions"><button class="danger mini">削除</button></div>`;
    const mInputs=card.querySelectorAll("input");
    const mName=mInputs[0], mBuy=mInputs[1], mPts=mInputs[2];
    const mDiff=card.querySelectorAll("b")[0];
    const mProf=card.querySelectorAll("b")[1];

    mName.value=p.name; mBuy.value=p.buyIn; mPts.value=p.finalPts;

    // Sync (nameは再計算不要なので軽く)
    nameI.addEventListener("input", ()=>{ p.name=nameI.value; mName.value=p.name; save(); copyText.value=buildFullCopyText(); });
    mName.addEventListener("input", ()=>{ p.name=mName.value; nameI.value=p.name; save(); copyText.value=buildFullCopyText(); });

    bindPair(buyI, mBuy, (v)=>p.buyIn=v);
    bindPair(ptsI, mPts, (v)=>p.finalPts=v);

    const remove=()=>{
      players=players.filter(x=>x!==p);
      tr.remove(); card.remove();
      save(); renderHeaderAndComputedAll();
    };
    tr.querySelector("button").onclick=remove;
    card.querySelector("button").onclick=remove;

    tbody.appendChild(tr);
    mobileWrap.appendChild(card);

    p.dom={diffTd,profitTd,mDiff,mProf,card};
    save();
    renderHeaderAndComputedAll();
  }

  function addPlayer(){
    addPlayerWithData({id:crypto.randomUUID(),name:"",buyIn:"",finalPts:""});
  }

  function load(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      const data=JSON.parse(raw);

      sb.value=data.sbPts??""; bb.value=data.bbPts??""; bbYen.value=data.bbYen??"";
      lastSettlementLines=Array.isArray(data.lastSettlementLines)?data.lastSettlementLines:[];
      players=[]; tbody.innerHTML=""; mobileWrap.innerHTML="";

      (data.players||[]).forEach(pp=>addPlayerWithData(pp));
      if(lastSettlementLines.length) settlementList.innerHTML=lastSettlementLines.join("<br>");
      saveState.textContent="復元済み";
      saveState.className="badge ok";
      renderHeaderAndComputedAll();
      return true;
    }catch(e){
      saveState.textContent="復元失敗";
      saveState.className="badge warn";
      return false;
    }
  }

  // ===== 履歴機能（追加） =====
  const hid = () => (crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2)));

  function loadHistory(){
    try{
      const raw=localStorage.getItem(HISTORY_KEY);
      history = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(history)) history=[];
    }catch{
      history=[];
    }
  }

  function persistHistory(){
    try{
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }catch(e){
      alert("履歴の保存に失敗しました（容量不足の可能性があります）");
    }
  }

  function applyState(state){
    sb.value = state.sbPts ?? "";
    bb.value = state.bbPts ?? "";
    bbYen.value = state.bbYen ?? "";
    lastSettlementLines = Array.isArray(state.lastSettlementLines) ? state.lastSettlementLines : [];

    players=[]; tbody.innerHTML=""; mobileWrap.innerHTML="";
    (state.players||[]).forEach(pp=>addPlayerWithData(pp));

    settlementList.innerHTML = lastSettlementLines.length ? lastSettlementLines.join("<br>") : "未集計";

    save();
    renderHeaderAndComputedAll();
  }

  function addHistoryEntry(){
    const title = ($("historyTitle")?.value || "").trim();
    const entry = {
      id: hid(),
      savedAt: new Date().toISOString(),
      title,
      state: snapshot()
    };
    history.unshift(entry);
    history = history.slice(0, 50);
    persistHistory();
    renderHistory();
  }

  const esc = (s)=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

  function renderHistory(){
    const wrap = $("historyList");
    if(!wrap) return;

    if(!history.length){
      wrap.textContent = "履歴なし";
      return;
    }

    const fmt = (iso)=>{
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      return d.toLocaleString("ja-JP");
    };

    wrap.innerHTML = history.map(h=>{
      const st=h.state||{};
      const t = h.title ? h.title : "(タイトルなし)";
      const count = (st.players||[]).length;
      const buy = (st.players||[]).reduce((a,p)=>a+Number(p.buyIn||0),0);
      return `
        <div class="pCard">
          <div class="muted">${esc(fmt(h.savedAt))}</div>
          <div style="margin-top:4px;"><b>${esc(t)}</b></div>
          <div class="muted" style="margin-top:6px;">
            人数：${count} / 合計Buy-in：${fmtInt(buy)}円
          </div>
          <div class="pActions" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="mini primary" data-act="load" data-id="${esc(h.id)}">読み込み（編集する）</button>
            <button class="mini danger" data-act="del" data-id="${esc(h.id)}">削除</button>
          </div>
        </div>
      `;
    }).join("");

    wrap.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        const entry = history.find(x=>x.id===id);
        if(!entry) return;

        if(act==="load"){
          applyState(entry.state);
          window.scrollTo({top:0, behavior:"smooth"});
        }

        if(act==="del"){
          if(confirm("この履歴を削除しますか？")){
            history = history.filter(x=>x.id!==id);
            persistHistory();
            renderHistory();
          }
        }
      };
    });
  }

  // Events
  $("addPlayer").onclick=addPlayer;

  $("resetAll").onclick=()=>{
    if(confirm("入力内容をすべて消して初期化しますか？（保存データも削除）")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  };

  $("aggregate").onclick=()=>{
    const {ypp}=totals();
    if(!ypp) return alert("レート未設定");

    let winners=[], losers=[];
    for(const p of players){
      const pr=profitYen(p,ypp);
      const name=(p.name&&p.name.trim())?p.name.trim():"(未入力)";
      if(pr>0) winners.push({n:name,a:pr});
      if(pr<0) losers.push({n:name,a:-pr});
    }
    winners.sort((a,b)=>b.a-a.a);
    losers.sort((a,b)=>b.a-a.a);

    let res=[];
    while(winners.length && losers.length){
      const w=winners[0], l=losers[0];
      const x=Math.min(w.a,l.a);
      res.push(`${l.n} → ${w.n}：${fmtInt(x)}円`);
      w.a-=x; l.a-=x;
      if(!w.a) winners.shift();
      if(!l.a) losers.shift();
    }

    lastSettlementLines = res.length ? res : ["精算なし"];
    settlementList.innerHTML = lastSettlementLines.join("<br>");
    save();
    copyText.value = buildFullCopyText();
  };

  $("copySettlement").onclick=async()=>{
    try{
      await navigator.clipboard.writeText(copyText.value||"");
      alert("コピーしました");
    }catch{
      alert("コピーできませんでした。下のテキスト欄から手動でコピーしてください。");
    }
  };

  document.querySelectorAll("[data-rate]").forEach(b=>{
    b.onclick=()=>{
      const [s,bp]=b.dataset.rate.split(",");
      sb.value=s; bb.value=bp;
      save(); renderHeaderAndComputedAll();
    };
  });
  document.querySelectorAll("[data-bbyen]").forEach(b=>{
    b.onclick=()=>{
      bbYen.value=b.dataset.bbyen;
      save(); renderHeaderAndComputedAll();
    };
  });

  [sb,bb,bbYen].forEach(el=>el.addEventListener("input", ()=>{ save(); renderHeaderAndComputedAll(); }));

  // 履歴ボタン
  $("saveHistory").onclick=()=>{
    addHistoryEntry();
    const t = $("historyTitle");
    if(t) t.value = "";
  };

  // Boot
  loadHistory();
  renderHistory();

  if(!load()){
    saveState.textContent="未保存";
    saveState.className="badge";
    copyText.value=buildFullCopyText();
  }
})();
</script>

<!-- Service Worker 登録（オフライン対応） -->
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }
</script>

</body>
</html>
